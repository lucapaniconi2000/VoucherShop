<div class="page">

  <div class="grid">
    <!-- USERS + CREATE -->
    <section class="card">
      <header class="card__head">
        <h2 class="h2">Users</h2>
        <button class="btn btn--ghost" type="button" (click)="reloadUsers()">Reload</button>
      </header>

      <ng-container *ngIf="usersVm$ | async as vm">
        <p *ngIf="vm.state === 'loading'" class="muted">Loading users…</p>
        <p *ngIf="vm.state === 'error'" class="error">{{ vm.message }}</p>
        <p *ngIf="vm.state === 'empty'" class="muted">Nessun utente nello shop.</p>

        <ul *ngIf="vm.state === 'ready'" class="list">
          <li *ngFor="let u of vm.users; trackBy: trackByUserId">
            <button type="button" class="user" (click)="selectUser(u)">
              <div class="user__main">{{ u.email }}</div>
              <div class="user__sub">{{ u.userName || u.id }}</div>
            </button>
          </li>
        </ul>
      </ng-container>

      <hr class="sep" />

      <h3 class="h3">Create user</h3>

      <form class="form" [formGroup]="createUserForm">
        <div class="field">
          <div class="label">Email</div>
          <input class="input" formControlName="email" placeholder="email utente" />
          <small *ngIf="createEmailCtrl.touched && createEmailCtrl.errors?.['required']" class="muted">Email obbligatoria</small>
          <small *ngIf="createEmailCtrl.touched && createEmailCtrl.errors?.['email']" class="error">Email non valida</small>
        </div>

        <div class="field">
          <div class="label">Password</div>
          <input class="input" type="password" formControlName="password" placeholder="min 8 caratteri" />
          <small *ngIf="createPasswordCtrl.touched && createPasswordCtrl.errors?.['required']" class="muted">Password obbligatoria</small>
          <small *ngIf="createPasswordCtrl.touched && createPasswordCtrl.errors?.['minlength']" class="error">Minimo 8 caratteri</small>
        </div>

        <ng-container *ngIf="createUserVm$ | async as vm">
          <div class="actions">
            <button class="btn btn--primary" type="button" (click)="createUser()"
                    [disabled]="createUserForm.invalid || vm.state === 'loading'">
              {{ vm.state === 'loading' ? 'Creazione…' : 'Create User' }}
            </button>

            <small *ngIf="vm.state === 'success'" class="ok">{{ vm.message }}</small>
            <small *ngIf="vm.state === 'error'" class="error">{{ vm.message }}</small>
          </div>
        </ng-container>
      </form>
    </section>

    <!-- VOUCHER + UPDATE -->
    <section class="card">
      <header class="card__head">
        <h2 class="h2">Voucher</h2>
        <button class="btn btn--ghost" type="button" (click)="loadHistory()">Reload History</button>
      </header>

      <ng-container *ngIf="voucherVm$ | async as vm">
        <p *ngIf="vm.state === 'idle'" class="muted">Seleziona un utente per vedere il totale.</p>
        <p *ngIf="vm.state === 'loading'" class="muted">Caricamento voucher…</p>
        <p *ngIf="vm.state === 'error'" class="error">{{ vm.message }}</p>

        <div *ngIf="vm.state === 'ready'" class="voucher">
          <div class="muted">Totale attuale</div>
          <div class="voucher__big">{{ vm.voucher.amount }} <span class="muted">{{ vm.voucher.currency }}</span></div>

          <div class="meta">
            <div>Updated: <b>{{ vm.voucher.updatedAt | date:'medium' }}</b></div>
            <div>
              Expires: <b>{{ vm.voucher.expiresAt | date:'medium' }}</b>
              <span *ngIf="vm.voucher.isExpired" class="badge badge--danger">EXPIRED</span>
            </div>
          </div>
        </div>
      </ng-container>

      <hr class="sep" />

      <h3 class="h3">Update voucher</h3>

      <form class="form" [formGroup]="form">
        <div class="field">
          <div class="label">UserId</div>
          <input class="input" formControlName="userId" placeholder="GUID utente" />
          <small *ngIf="userIdCtrl.touched && userIdCtrl.errors?.['required']" class="muted">UserId è obbligatorio</small>
          <small *ngIf="userIdCtrl.touched && userIdCtrl.errors?.['guid']" class="error">UserId non è un GUID valido</small>
        </div>

        <div class="two">
          <div class="field">
            <div class="label">New Amount</div>
            <input class="input" type="number" formControlName="newAmount" min="0" step="0.01" />
            <small *ngIf="amountCtrl.touched && amountCtrl.errors?.['required']" class="muted">Importo obbligatorio</small>
            <small *ngIf="amountCtrl.touched && amountCtrl.errors?.['min']" class="error">L’importo non può essere negativo</small>
          </div>

          <div class="field">
            <div class="label">Expires At</div>
            <input class="input" type="datetime-local" formControlName="expiresAtLocal" />
            <small *ngIf="expiresCtrl.touched && expiresCtrl.errors?.['required']" class="muted">Scadenza obbligatoria</small>
            <small *ngIf="expiresAtUtcPreview" class="muted">UTC che verrà inviato: <b>{{ expiresAtUtcPreview }}</b></small>
          </div>
        </div>

        <ng-container *ngIf="updateVm$ | async as u">
          <div class="actions">
            <button class="btn btn--primary" type="button" (click)="updateVoucher()"
                    [disabled]="form.invalid || u.state === 'loading'">
              {{ u.state === 'loading' ? 'Aggiornamento…' : 'Update Voucher' }}
            </button>

            <small *ngIf="u.state === 'success'" class="ok">{{ u.message }}</small>
            <small *ngIf="u.state === 'error'" class="error">{{ u.message }}</small>

            <span class="spacer"></span>

            <button class="btn btn--ghost" type="button" (click)="loadHistory()" [disabled]="userIdCtrl.invalid">
              Load History
            </button>
          </div>
        </ng-container>
      </form>
    </section>
  </div>

  <!-- HISTORY -->
  <section class="card">
    <header class="card__head">
      <h2 class="h2">History</h2>
      <button class="btn btn--ghost" type="button" (click)="loadHistory()">Reload</button>
    </header>

    <ng-container *ngIf="historyVm$ | async as h">
      <p *ngIf="h.state === 'idle'" class="muted">Seleziona un utente o premi “Load History”.</p>
      <p *ngIf="h.state === 'loading'" class="muted">Caricamento…</p>
      <p *ngIf="h.state === 'empty'" class="muted">Nessuna modifica registrata.</p>
      <p *ngIf="h.state === 'error'" class="error">{{ h.message }}</p>

      <ul *ngIf="h.state === 'ready'" class="audit">
        <li *ngFor="let it of h.items; trackBy: trackByAudit" class="audit__li">
          <div class="audit__marker"></div>

          <article class="audit__card">
            <div class="audit__top">
              <span class="badge" 
                    [class.badge--update]="it.action === 'Update'"
                    [class.badge--create]="it.action === 'Create'">
                {{ it.action }}
              </span>
              <span class="audit__time">{{ it.performedAt | date:'medium' }}</span>
            </div>

            <div class="audit__meta">
              By <code class="mono">{{ it.performedByUserId }}</code>
            </div>

            <ng-container *ngIf="parseChanges(it.changesJson) as c">
              <div class="diff">
                <div class="diff__row" *ngIf="c?.amount">
                  <span class="k">Amount</span>
                  <span class="v"><b>{{ c.amount.old ?? '—' }}</b> → <b>{{ c.amount.new ?? '—' }}</b></span>
                </div>

                <div class="diff__row" *ngIf="c?.currency">
                  <span class="k">Currency</span>
                  <span class="v"><b>{{ c.currency.old ?? '—' }}</b> → <b>{{ c.currency.new ?? '—' }}</b></span>
                </div>

                <div class="diff__row" *ngIf="c?.expiresAt">
                  <span class="k">Expires</span>
                  <span class="v">
                    <span class="mono">{{ c.expiresAt.old ?? '—' }}</span>
                    <span style="opacity:.7">→</span>
                    <span class="mono">{{ c.expiresAt.new ?? '—' }}</span>
                  </span>
                </div>
              </div>

              <details>
                <summary>Raw JSON</summary>
                <pre>{{ c | json }}</pre>
              </details>
            </ng-container>
          </article>
        </li>
      </ul>
    </ng-container>
  </section>

</div>
