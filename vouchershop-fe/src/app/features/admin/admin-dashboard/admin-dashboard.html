<section class="card" style="margin-bottom: 12px;">
  <header class="card__header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Users</h2>
    <button class="btn btn-ghost" type="button" (click)="reloadUsers()">Reload</button>
  </header>

  <ng-container *ngIf="usersVm$ | async as vm">
    <p *ngIf="vm.state === 'loading'" style="color: rgba(255,255,255,.7); margin: 8px 0;">
      Loading users…
    </p>

    <p *ngIf="vm.state === 'error'" style="color: rgba(255,90,122,.9); margin: 8px 0;">
      {{ vm.message }}
    </p>

    <p *ngIf="vm.state === 'empty'" style="color: rgba(255,255,255,.7); margin: 8px 0;">
      Nessun utente nello shop.
    </p>

    <ul *ngIf="vm.state === 'ready'" style="list-style:none; padding:0; margin: 8px 0; display:grid; gap:8px;">
      <li *ngFor="let u of vm.users; trackBy: trackByUserId">
        <button
          type="button"
          class="btn btn-ghost"
          style="width:100%; text-align:left; display:flex; flex-direction:column; gap:2px;"
          (click)="selectUser(u)"
        >
          <span style="font-weight:600;">{{ u.email }}</span>
          <span style="color: rgba(255,255,255,.6); font-size: 12px;">
            {{ u.userName || u.id }}
          </span>
        </button>
      </li>
    </ul>
  </ng-container>
</section>
<section class="card" style="margin-bottom: 12px;">
  <h2 style="margin:0 0 8px 0;">Create user</h2>

  <form class="form" [formGroup]="createUserForm">
    <label class="label">
      Email
      <input class="input" formControlName="email" placeholder="email utente" />
      <small *ngIf="createEmailCtrl.touched && createEmailCtrl.errors?.['required']" style="color: rgba(255,255,255,.7)">
        Email obbligatoria
      </small>
      <small *ngIf="createEmailCtrl.touched && createEmailCtrl.errors?.['email']" style="color: rgba(255,90,122,.9)">
        Email non valida
      </small>
    </label>

    <label class="label">
      Password
      <input class="input" type="password" formControlName="password" placeholder="min 8 caratteri" />
      <small *ngIf="createPasswordCtrl.touched && createPasswordCtrl.errors?.['required']" style="color: rgba(255,255,255,.7)">
        Password obbligatoria
      </small>
      <small *ngIf="createPasswordCtrl.touched && createPasswordCtrl.errors?.['minlength']" style="color: rgba(255,90,122,.9)">
        Minimo 8 caratteri
      </small>
    </label>

    <ng-container *ngIf="createUserVm$ | async as vm">
      <div class="row" style="margin-top: 6px;">
        <button class="btn" type="button" (click)="createUser()"
                [disabled]="createUserForm.invalid || vm.state === 'loading'">
          {{ vm.state === 'loading' ? 'Creazione…' : 'Create User' }}
        </button>

        <small *ngIf="vm.state === 'success'" style="color: rgba(140,255,170,.9); align-self:center;">
          {{ vm.message }}
        </small>

        <small *ngIf="vm.state === 'error'" style="color: rgba(255,90,122,.9); align-self:center;">
          {{ vm.message }}
        </small>
      </div>
    </ng-container>
  </form>
</section>

<form class="form" [formGroup]="form">
  <label class="label">
    UserId
    <input class="input" formControlName="userId" placeholder="GUID utente" />

    <small
      *ngIf="userIdCtrl.touched && userIdCtrl.errors?.['required']"
      style="color: rgba(255,255,255,.7)"
    >
      UserId è obbligatorio
    </small>

    <small
      *ngIf="userIdCtrl.touched && userIdCtrl.errors?.['guid']"
      style="color: rgba(255,90,122,.9)"
    >
      UserId non è un GUID valido
    </small>
  </label>

  <div class="row">
    <label class="label" style="flex: 1;">
      New Amount
      <input
        class="input"
        type="number"
        formControlName="newAmount"
        min="0"
        step="0.01"
      />

      <small
        *ngIf="amountCtrl.touched && amountCtrl.errors?.['required']"
        style="color: rgba(255,255,255,.7)"
      >
        Importo obbligatorio
      </small>

      <small
        *ngIf="amountCtrl.touched && amountCtrl.errors?.['min']"
        style="color: rgba(255,90,122,.9)"
      >
        L’importo non può essere negativo
      </small>
    </label>

    <label class="label" style="flex: 1;">
      Expires At
      <input
        class="input"
        type="datetime-local"
        formControlName="expiresAtLocal"
      />

      <small
        *ngIf="expiresCtrl.touched && expiresCtrl.errors?.['required']"
        style="color: rgba(255,255,255,.7)"
      >
        Scadenza obbligatoria
      </small>

      <small
        *ngIf="expiresAtUtcPreview"
        style="color: rgba(255,255,255,.7)"
      >
        UTC che verrà inviato: <b>{{ expiresAtUtcPreview }}</b>
      </small>
    </label>
  </div>

  <!-- Bottoni: leggiamo entrambi gli stati (update + history) -->
  <ng-container *ngIf="(updateVm$ | async) as u">
    <ng-container *ngIf="(historyVm$ | async) as h">
      <div class="row" style="margin-top: 6px;">
        <button
          class="btn"
          type="button"
          (click)="updateVoucher()"
          [disabled]="form.invalid || u.state === 'loading'"
        >
          {{ u.state === 'loading' ? 'Aggiornamento…' : 'Update Voucher' }}
        </button>

        <button
          class="btn btn-ghost"
          type="button"
          (click)="loadHistory()"
          [disabled]="userIdCtrl.invalid || h.state === 'loading'"
        >
          {{ h.state === 'loading' ? 'Caricamento…' : 'Load History' }}
        </button>
      </div>
    </ng-container>
  </ng-container>
</form>
